import sys

def ApproveOperation(config, oTransaksi): 
  oTransaksi = oTransaksi.CastToLowestDescendant()
  
  if oTransaksi.IsA("IuranPeserta"):
    #tambahkan mutasi dana di RekeningInvDPLK
    oRekInv = config.CreatePObjImplProxy('RekInvDPLK') 
    oRekInv.Key = oTransaksi.no_rekening
    oRekInv.akum_iuran_pk += oTransaksi.mutasi_iuran_pk
    oRekInv.akum_iuran_pst += oTransaksi.mutasi_iuran_pst
    oRekInv.akum_iuran_tmb += oTransaksi.mutasi_iuran_tmb
    
    #tambahkan mutasi dana dan unit di tiap RekeningDPLK terkait investasi
    Ls_DetilTransaksi = oTransaksi.Ls_DetilTransaksiDPLK
    while not Ls_DetilTransaksi.EndOfList:
      oDetilTransaksi = Ls_DetilTransaksi.CurrentElement
      
      oRekDPLK = config.CreatePObjImplProxy('RekeningDPLK')
      oRekDPLK.Key = oDetilTransaksi.nomor_rekening
      oRekDPLK.akum_iuran_pk += oDetilTransaksi.mutasi_iuran_pk
      oRekDPLK.akum_iuran_pst += oDetilTransaksi.mutasi_iuran_pst
      oRekDPLK.akum_iuran_tmb += oDetilTransaksi.mutasi_iuran_tmb
      
      Ls_DetilTransaksi.Next()
    #--  

def RejectOperation(config, oTransaksi):
  oTransaksi = oTransaksi.CastToLowestDescendant()
  
  #hapus list Advis history dan detil transaksi DPLK
  if o.IsA("TransaksiDPLK"):
    o.Ls_AdvisHistory.DeleteAllPObjs()
    o.Ls_DetilTransaksiDPLK.DeleteAllPObjs()
  
  #hapus objek transaksi
  o.Delete()
    
  return 1

def GoOperasiWithMode(config, idTransaksi, mode):
  oTransaksi = config.CreatePObjImplProxy('TransaksiRekInvDPLK')
  oTransaksi.Key = idTransaksi

  if mode == 'A':
    #mode Approval
    ApproveOperation(config, oTransaksi)

  elif mode == 'R':
    #mode Rejection
    RejectOperation(config, oTransaksi)

  elif mode == 'V':
    #mode Verify, not defined yet...used in massal import
    pass

  return 1

def ProsesOtorisasi(config, idTransaksi, mode):
  config.BeginTransaction()
  try:
    GoOperasiWithMode(config, idTransaksi, mode)

    config.Commit()
    errorStatus = 0
    errorMessage = ""
  except:
    config.Rollback()
    errorStatus = 1
    errorMessage = "Gagal otorisasi transaksi: "+ str(sys.exc_info()[1])

  return errorStatus, errorMessage

def DAFScriptMain(config, parameter, returnpacket):
  # config: ISysConfig object
  # parameter: TPClassUIDataPacket
  # returnpacket: TPClassUIDataPacket (undefined structure)

  #mode value: 'A' Approve, 'R' Reject, 'V' Verify   
  mode = parameter.FirstRecord.mode 
  idTransaksi = parameter.FirstRecord.id_transaksi
  
  #proses otorisasi transaksi
  errorStatus, errorMessage = ProsesOtorisasi(config, idTransaksi, mode)
  
  ds = returnpacket.AddNewDatasetEx("status", "error_status: integer; error_message: string;")
  rec = ds.AddRecord()
  rec.error_status = errorStatus
  rec.error_message = errorMessage

  return 1